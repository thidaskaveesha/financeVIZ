# FinanceVIZ Authentication Backend

A secure Node.js backend for user authentication with Supabase integration.

## Features

- üîê Secure password hashing with bcrypt
- üìß Email verification system
- üîë Password reset functionality
- üé´ JWT token-based authentication
- üõ°Ô∏è CORS and security headers
- ‚úÖ Input validation

## API Endpoints

### 1. Login
**POST** `/api/auth/login`

Request body:
```json
{
  "username": "your_username",
  "password": "your_password"
}
```

Response:
```json
{
  "message": "Login successful",
  "token": "jwt_token_here",
  "user": {
    "userId": 1,
    "username": "your_username",
    "email": "user@example.com",
    "subscriptionLevel": "free",
    "firstTimeLogin": false,
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

### 2. Sign Up
**POST** `/api/auth/signup`

Request body:
```json
{
  "username": "new_user",
  "password": "secure_password",
  "email": "user@example.com"
}
```

Response:
```json
{
  "message": "Account created successfully. Please check your email for verification code.",
  "userId": 1,
  "email": "user@example.com"
}
```

### 3. Verify Email
**POST** `/api/auth/verify-email`

Request body:
```json
{
  "email": "user@example.com",
  "code": 12345678
}
```

Response:
```json
{
  "message": "Email verified successfully",
  "token": "jwt_token_here",
  "user": {
    "userId": 1,
    "username": "new_user",
    "email": "user@example.com",
    "subscriptionLevel": "free",
    "firstTimeLogin": true,
    "emailVerified": true
  }
}
```

### 4. Reset Password (Request)
**POST** `/api/auth/reset-password`

Request body:
```json
{
  "email": "user@example.com"
}
```

Response:
```json
{
  "message": "If the email exists, a reset code has been sent."
}
```

### 5. Reset Password (Verify & Update)
**POST** `/api/auth/reset-password/verify`

Request body:
```json
{
  "email": "user@example.com",
  "code": 12345678,
  "newPassword": "new_secure_password"
}
```

Response:
```json
{
  "message": "Password reset successfully"
}
```

## Setup Instructions

1. **Install dependencies:**
   ```bash
   npm install
   ```

2. **Configure environment variables:**
   - Copy `.env.example` to `.env`
   - Fill in your Supabase credentials
   - Configure email settings (SMTP)
   - Set a secure JWT secret

3. **Set up Supabase:**
   - Create a Supabase project
   - Run the provided SQL to create the `user` table
   - Get your project URL and API keys from Supabase dashboard

4. **Configure Email (Gmail example):**
   - Enable 2-factor authentication on your Gmail account
   - Generate an App Password: https://myaccount.google.com/apppasswords
   - Use the app password in `EMAIL_PASS`

5. **Start the server:**
   ```bash
   npm start
   ```
   
   For development with auto-reload:
   ```bash
   npm run dev
   ```

## Environment Variables

```env
# Supabase Configuration
SUPABASE_URL=your_supabase_project_url
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# Server Configuration
PORT=3000
NODE_ENV=development

# JWT Configuration
JWT_SECRET=your_super_secret_jwt_key_change_this_in_production
JWT_EXPIRES_IN=7d

# Email Configuration
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_app_password
EMAIL_FROM=noreply@financeviz.com

# Frontend URL (for CORS)
FRONTEND_URL=http://localhost:3000
```

## Security Features

- Password hashing with bcrypt and unique salts
- JWT tokens for secure authentication
- CORS protection
- Security headers (XSS protection, frame options, etc.)
- Input validation with express-validator
- Email verification before account activation
- Time-limited reset codes (5 minutes)
- Time-limited verification codes (30 minutes)

## Database Schema

The backend expects a `user` table with the following structure:

```sql
create table public.user (
  user_id bigint generated by default as identity not null,
  created_at timestamp with time zone not null,
  username text not null,
  access_token text not null,
  hashed_password text not null,
  salt text not null,
  first_time_login boolean not null,
  subscription_level text not null,
  user_email text not null,
  email_verified boolean not null,
  reset_code bigint null,
  reset_code_expiring_time timestamp with time zone null,
  verify_email_code bigint null,
  verify_email_expiring_time timestamp with time zone null,
  constraint user_pkey primary key (user_id),
  constraint user_id_key unique (user_id),
  constraint user_username_key unique (username)
) TABLESPACE pg_default;
```

## Error Handling

All endpoints return appropriate HTTP status codes:
- `200` - Success
- `201` - Created
- `400` - Bad Request (validation errors)
- `401` - Unauthorized (invalid credentials)
- `403` - Forbidden (email not verified)
- `404` - Not Found
- `409` - Conflict (username/email already exists)
- `500` - Internal Server Error

## Notes

- Reset codes expire after 5 minutes
- Verification codes expire after 30 minutes
- Passwords must be at least 8 characters
- Usernames must be at least 3 characters and can only contain letters, numbers, and underscores
- Email verification is required before login
